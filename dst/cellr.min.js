!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.cellr=e()}(this,function(){"use strict";function t(t,e){for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);return t}function e(e,s){var a=s(e),i=a._constructor;return delete a._constructor,i.prototype=e.prototype?t(Object.create(e.prototype),a):a,i}var s=e({},function(){return{_constructor:function(){this._callbacks={}},emit:function(t){var e=this._callbacks[t];if(e&&e.length){for(var s=[],a=1,i=arguments.length;i>a;a++)s.push(arguments[a]);for(var a=0,i=e.length;i>a;a++)e[a].apply(this,s)}},on:function(t,e){var s=this._callbacks;s[t]=s[t]||[],s[t].push(e)}}}),a=Function("return this;")(),i=a.Map,r=a.Set,n=e(s,function(t){function e(){l=!0;for(var t=o;h>=t;t++)for(var e,s=n.get(t),i=s.values();e=i.next().value;)for(var r,c=e.forwards.values();r=c.next().value;)r.calc();n.clear(),o=a,h=-1,l=!1}var s=null,a=1e9,n=new i,l=!1,o=a,c=0,h=-1;return{_constructor:function(e){t.call(this),this._id=++c,this.forwards=new r,this.backwards=new r,this.oldLevel=-1,"function"==typeof e?(this._calc=e,this.sta=0):(this._val=e,this.sta=2),this.level=0},calc:function(){if(this._calc){this.sta=1;var t=s;s=this;var e=this.backwards;this.backwards=new r;for(var a,i=this._calc(),n=this.backwards,l=e.values();a=l.next().value;)n.has(a)||a.forwards["delete"](this);s=t,this.set(i)}},get:function(){var t=s;if(t&&(this.forwards.has(t)||(this.forwards.add(t),t.backwards.add(this))),0==this.sta&&this.calc(),o<=this.level&&!l&&e(),t&&t.level<=this.level&&t._setLevel(this.level+1),"undefined"==typeof this._val)throw new Error("undefined val");return this._val},set:function(t){var e=!(this._val==t);this._val=t,this.sta=2,e&&this._addToPlan()},_addToPlan:function(){var t=this.level;this._setLevel(t)},_setLevel:function(t){this.level=t;var e=n.get(t);if(e||(e=new r,n.set(t,e)),o>t&&(o=t),t>h&&(h=t),!e.has(this)){var s=this.oldLevel;s>=0&&n.get(s)["delete"](this),e.add(this)}this.oldLevel=t}}}),l={Cell:n};return l});