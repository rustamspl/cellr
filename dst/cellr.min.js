!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.cellr=e()}(this,function(){"use strict";function t(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t}function e(e,i){var s=i(e),r=s._constructor;return delete s._constructor,r.prototype=e.prototype?t(Object.create(e.prototype),s):s,r}var i=e({},function(t){return{_constructor:function(){this._callbacks={}},emit:function(t){var e=this._callbacks[t];if(e&&e.length){for(var i=[],s=1,r=arguments.length;s<r;s++)i.push(arguments[s]);for(var s=0,r=e.length;s<r;s++)e[s].apply(this,i)}},on:function(t,e){var i=this._callbacks;i[t]=i[t]||[],i[t].push(e)}}}),s=e(i,function(t){function e(t){console.log("planRun",t),a=!0;var e=r.plan;for(var i in e){if(i>t&&t>=0)break;var s=e[i];for(var l in s)s[l].calc()}r.plan={},r.levels={},n=-1,a=!1}var i=[],s=0,r={plan:{},levels:{}},n=-1,a=!1;return{_constructor:function(e){t.call(this),this.id=++s,this.forwards={},this.backwards={},"function"==typeof e?(this._calc=e,this.sta=0,this.level=1):(this.value=e,this.sta=1,this.level=-1)},get:function(){var t,s=i.length-1;switch(s>=0&&(t=i[s],t.id in this.forwards||(this.forwards[t.id]=t,t.backwards[this.id]=this)),this.sta){case 2:throw new Error("circular dependence");case 0:this.calc()}return t&&t.level<=this.level&&(t.level=this.level+1),n==-1||a||e(this.level),console.log("get",this.id,this.level),this.value},set:function(t){var e=!(this.value==t);if(this.value=t,this.sta=1,e)for(var i in this.forwards)this.forwards[i]._addToPlan()},calc:function(){if(this._calc){this.sta=2;var t=this.backwards;this.backwards={},i.push(this);var e=this._calc(),s=this.backwards,r=this.id;for(var n in t)s[n]||delete t[n].forwards[r];i.pop(),this.set(e)}},_addToPlan:function(){var t=this.level,e=this.id,i=r.plan,s=r.levels,n=i[t]||(i[t]={});if(!n[e]){if(e in s){var a=s[e];if(a<=t)return;delete i[s[e]][e]}n[e]=this,s[e]=t}(n==-1||n>t)&&(n=t)}}}),r={Cell:s};return r});
