!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.cellr=e()}(this,function(){"use strict";function t(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}function e(e,n){var r=n(e),a=r._constructor;return delete r._constructor,a.prototype=e.prototype?t(Object.create(e.prototype),r):r,a}var n=e({},function(){return{_constructor:function(){this._callbacks={}},emit:function(t){var e=this._callbacks[t];if(e&&e.length){for(var n=[],r=1,a=arguments.length;a>r;r++)n.push(arguments[r]);for(var r=0,a=e.length;a>r;r++)e[r].apply(this,n)}},on:function(t,e){var n=this._callbacks;n[t]=n[t]||[],n[t].push(e)}}}),r=Function("return this;")(),a=r.Map,i=r.Set,s=e(n,function(t){function e(){incCnt("r.planRun"),l=!0;for(var t=c;o>=t;t++)for(var e,n=s.get(t),a=n.values();e=a.next().value;)e.calc();s.clear(),c=r,o=-1,l=!1}var n=null,r=1e9,s=new a,l=!1,c=r,o=-1,h=0;return{_constructor:function(e){incCnt("r._constructor"),t.call(this),this._id=++h,this.forwards=new i,this.backwards=new i,this.level=0,"function"==typeof e?(this._calc=e,this.sta=0):(this._val=e,this.sta=2)},calc:function(){if(incCnt("r.calc"),this._calc){if(1==this.sta)throw new Error("circular");if(this.sta=1,!l){var t=this.backwards,e=new i;this.backwards=e}var r=n;n=this;var a=this._calc();if(n=r,!l)for(var s,c=t.values();s=c.next().value;)e.has(s)||s.forwards["delete"](this);this.planLevel=-1,this.set(a)}},get:function(){incCnt("r.get");var t=n;return t&&(this.forwards.add(t),t.backwards.add(this)),0==this.sta&&this._addToPlan(),c<=this.level&&!l&&e(),t&&t.level<=this.level&&(t.level=this.level+1),this._val},set:function(t){incCnt("r.set");var e=!(this._val==t);if(this._val=t,this.sta=2,e)for(var t,n=this.forwards.values();t=n.next().value;)t._addToPlan()},_addToPlan:function(){incCnt("r._addToPlan");var t=this.level,e=this.planLevel;if(e!=t){if(e>t){var n=s.get(e);n&&n["delete"](this)}var r=s.get(t);r||(r=new i,s.set(t,r)),r.add(this),this.planLevel=t,c>t&&(c=t),t>o&&(o=t)}}}}),l={Cell:s};return l});